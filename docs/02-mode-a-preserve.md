<!-- docs/02-mode-a-preserve.md -->
# 模式 A：保留订阅原始 group/rules（原理与实现细节）

← [返回 README](../README.md)  
→ 下一篇：[模式 B：内置模板分组/规则](03-mode-b-acl4ssr.md)

> 模式 A 适合：订阅自带 proxy-groups 很复杂（地区组/媒体组/Telegram 组/自动测速组等），你希望尽量保留原结构，只做必要的“命名空间化”和“provider 化改写”。

---

## 1) 模式 A 做了什么（概览）

对每个订阅（命名空间为 `ns`）：

1. 远程订阅：生成 `proxy-providers.ns`
2. 给订阅中的所有 group / proxy 名做命名空间：`ns/<原名>`
3. 对订阅自带的 `proxy-groups` 做“叶子/非叶子”重写（下面详解）
4. 订阅自带 `rules` 进入 `sub-rules.rules_<ns>`，并让该端口 listener 绑定 `rule: rules_<ns>`

---

## 2) 默认组已移除（当前行为）

当前版本不再自动创建 `ns/默认` / `ALL/默认`。处理策略改为：

- **远程订阅**：非叶子组如果包含节点枚举，会删除节点并补 `use: [ns]` 作为入口
- **本地订阅**：保留自身 `proxies` 列表
- **兜底**：当组里没有任何可用项时回退为 `DIRECT`

---

## 3) 叶子组 vs 非叶子组（核心）

> 订阅里的 proxy-groups 通常是一个树：上层组引用下层组，下层组包含具体节点。
> 我们把 group 分成两类：

### 3.1 叶子组（Leaf Group）
判定：组内 `proxies` **不引用任何其它 group**（只包含节点名和/或 BUILTIN，如 DIRECT/REJECT/PASS）。

典型例子：
- `🇯🇵 日本组` 里全是 `日本01/日本02/...`
- `自动选择` 里全是节点名
- `url-test` / `fallback` 的 proxies 里全是节点

**叶子组在 provider 场景下的问题：**
- provider 会更新节点列表，节点名字可能变化
- 如果你把叶子组的节点名“写死”在 `proxies:` 列表里，后续更新就会出现：
  - 节点不存在 / 名字对不上 / 组失效

**因此：远程订阅的叶子组会被“provider 化”：**
- 删除组内显式列出的节点名（避免写死）
- 改成 `use: [ns]`（让节点来自 provider）
-（可选）通过 `filter / exclude-filter` 控制筛选规则

> local 订阅无法 use provider，因此 local 的叶子组一般保持 `proxies:`（或者你另行实现 local 的 filter 机制）。

### 3.2 非叶子组（Non-leaf Group）
判定：组内 `proxies` **包含对其它 group 的引用**（例如 `proxies: [Auto, 香港组, 日本组, …, 日本01, 日本02]`）

典型例子：
- 顶层 “节点选择” 同时引用 `自动选择/地区组`，还枚举了一堆节点
- “漏网之鱼”引用上层组，也列了一堆节点

远程订阅场景下，如果非叶子组包含节点枚举，会被删除并补 `use: [ns]` 作为入口（不再使用 `ns/默认`）。

---

## 4) 非叶子节点删除原理（你提到的核心点）

### 4.1 为什么要“删除非叶子组里枚举的节点”
非叶子组里往往混了两类条目：
1) 其它组名（引用子组）  
2) 一堆具体节点名（枚举）

对于 **远程 provider 订阅**，第 2 类“节点枚举”最危险：
- provider 更新后，节点名可能变化
- 非叶子组里写死的节点会逐渐失效
- 同时，节点枚举会让顶层组变得巨大且难维护（每个订阅都不一样）

因此我们对非叶子组做一个“瘦身 + 可更新”重写：

### 4.2 删除规则（非叶子组重写逻辑）
对非叶子组的 `proxies` 列表逐项处理：

- **保留**：
  - BUILTIN：`DIRECT / REJECT / PASS`
  - 对其它 group 的引用（会被命名空间化为 `ns/<group>`）
- **丢弃**：
  - 具体节点名（以及无法判定的“非 group 引用项”）

### 4.3 关键补丁：为非叶子组补 `use: [ns]`（避免入口丢失）
删掉节点枚举后，非叶子组可能只剩“子组引用 + BUILTIN”。
为了保证顶层选择器仍然能直接选到“这个订阅的全部节点”，我们会：

- **只要非叶子组发生过“删除节点枚举”（远程订阅）**，就补 `use: [ns]`

这样顶层组至少包含：
- 原有子组引用（结构不丢）
- DIRECT/REJECT（如原来就有）
- provider 节点入口（通过 `use: [ns]`）

---

## 5) 模式 A 的最终效果（你会在 UI 看到什么）

- 原订阅的 group 树结构仍在（但已改名为 `ns/...`）
- 顶层组不会再塞满“过时的节点枚举”
- 非叶子组不会再塞满“过时的节点枚举”，必要时会出现 `use: [ns]`

---

## 6) 常见误解澄清

### “删了节点枚举，是不是丢失了订阅自带分组？”
不会。我们保留了 group 引用关系（树结构），只是删掉了非叶节点里“写死的节点列表”，避免 provider 更新后失效。

### “为什么不把所有组都改成 use？”
非叶子组本质是“组的组合”，如果全量 use 会破坏原来的组引用结构。因此：
- 叶子组：适合用 use（节点来源）
- 非叶子组：保留组引用（结构），只在需要节点入口时补 `use: [ns]`

---

下一篇：
→ [模式 B：内置模板分组/规则（订阅前缀 ns/…）](03-mode-b-acl4ssr.md)
